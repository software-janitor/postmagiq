# ============================================================================
# WORKFLOW ORCHESTRATOR CONFIGURATION - GROQ (Cloud API)
# ============================================================================
# Uses Groq's fast inference API for all agents
# Production models only: https://console.groq.com/docs/models
# Pricing is auto-set from runner/agents/groq_api.py MODEL_PRICING

orchestrator:
  agent: groq
  session:
    enabled: true

# ============================================================================
# WORKFLOW TIERS
# ============================================================================

tiers:
  standard:
    draft_agents: [groq-gpt-oss-120b, groq-gpt-oss-20b, groq-8b]
    audit_agents: [groq-gpt-oss-120b, groq-gpt-oss-20b]
  premium:
    draft_agents: [groq-gpt-oss-120b, groq-70b, groq-gpt-oss-20b]
    audit_agents: [groq-gpt-oss-120b, groq-70b]

credit_weights:
  base_cost: 2
  standard:
    - groq-gpt-oss-120b
    - groq-gpt-oss-20b
    - groq-8b
  premium:
    - groq-70b

# ============================================================================
# AGENT DEFINITIONS - Groq Production Models
# ============================================================================

agents:
  groq:
    type: api
    model: llama-70b
    context_window: 131072

  groq-70b:
    type: api
    model: llama-70b
    context_window: 131072

  groq-8b:
    type: api
    model: llama-8b
    context_window: 131072

  groq-gpt-oss-120b:
    type: api
    model: gpt-oss-120b
    context_window: 131072

  groq-gpt-oss-20b:
    type: api
    model: gpt-oss-20b
    context_window: 131072

  # Split auditor agents (same models, different personas)
  groq-fabrication-auditor:
    type: api
    model: gpt-oss-120b
    context_window: 131072

  groq-style-auditor:
    type: api
    model: gpt-oss-120b
    context_window: 131072

# ============================================================================
# PERSONA DEFINITIONS
# ============================================================================

personas:
  story-reviewer: prompts/templates/story_reviewer.md
  story-processor: prompts/templates/story_processor.md
  writer: prompts/templates/writer.md
  auditor: prompts/templates/auditor.md
  synthesizer: prompts/templates/synthesizer.md
  fabrication-auditor: prompts/templates/fabrication_auditor.md
  style-auditor: prompts/templates/style_auditor.md

# ============================================================================
# STATE MACHINE
# ============================================================================

states:
  start:
    type: initial
    next: story-review

  # --------------------------------------------------------------------------
  # PHASE 1: Story Review & Processing
  # --------------------------------------------------------------------------

  story-review:
    type: single
    description: "Review raw story for completeness - ask questions if needed"
    agent: groq-gpt-oss-120b
    persona: story-reviewer
    input: "workflow/input/story_input.md"
    output: "workflow/review/review_result.json"
    output_type: review
    transitions:
      proceed: story-process
      retry: story-feedback
      halt: halt

  story-feedback:
    type: human-approval
    description: "Get more details from user based on reviewer questions"
    input: "workflow/review/review_result.json"
    prompt: |
      The reviewer has questions about your story.
      Review the feedback above and either:
      - Type 'proceed' to continue with what you have
      - Type 'abort' to cancel
      - Provide the requested details to strengthen your story
    transitions:
      approved: story-process
      feedback: story-review
      abort: halt

  story-process:
    type: single
    description: "Extract 5 elements, determine shape, create processed template"
    agent: groq-gpt-oss-120b
    persona: story-processor
    input: "workflow/input/story_input.md"
    output: "workflow/processed/processed_story.md"
    output_type: processed
    transitions:
      success: draft
      failure: story-review

  # --------------------------------------------------------------------------
  # PHASE 2: Post Drafting
  # --------------------------------------------------------------------------

  draft:
    type: fan-out
    description: "Generate post drafts from processed story"
    agents: [groq-70b, groq-gpt-oss-120b, groq-gpt-oss-20b]
    persona: writer
    input: "workflow/processed/processed_story.md"
    output: "workflow/drafts/{agent}_draft.md"
    output_type: draft
    transitions:
      all_success: cross-audit
      partial_success: cross-audit
      all_failure: halt

  # --------------------------------------------------------------------------
  # PHASE 3: Auditing & Synthesis
  # --------------------------------------------------------------------------

  cross-audit:
    type: fan-out
    description: "Split audit: fabrication + style checks on drafts"
    agents: [groq-fabrication-auditor, groq-style-auditor]
    personas:
      groq-fabrication-auditor: fabrication-auditor
      groq-style-auditor: style-auditor
    input:
      - "workflow/processed/processed_story.md"
      - "workflow/input/story_input.md"
      - "workflow/drafts/*.md"
    output: "workflow/audits/{agent}_audit.json"
    output_type: audit
    transitions:
      proceed: synthesize
      retry: draft
      halt: halt

  synthesize:
    type: orchestrator-task
    description: "Combine best elements from drafts based on audits"
    agent: groq-gpt-oss-120b
    persona: synthesizer
    input:
      - "workflow/drafts/*.md"
      - "workflow/audits/*.json"
    output: "workflow/final/final_post.md"
    output_type: final
    transitions:
      success: final-audit
      failure: cross-audit

  # --------------------------------------------------------------------------
  # PHASE 4: Final Review & Approval
  # --------------------------------------------------------------------------

  final-audit:
    type: fan-out
    description: "Final split audit: fabrication + style checks on final post"
    agents: [groq-fabrication-auditor, groq-style-auditor]
    personas:
      groq-fabrication-auditor: fabrication-auditor
      groq-style-auditor: style-auditor
    input:
      - "workflow/processed/processed_story.md"
      - "workflow/input/story_input.md"
      - "workflow/final/final_post.md"
    output: "workflow/final/{agent}_final_audit.json"
    output_type: final_audit
    transitions:
      proceed: human-approval
      retry: final-audit-feedback
      halt: final-audit-feedback

  final-audit-feedback:
    type: human-approval
    description: "Review audit feedback on final post"
    input: "workflow/final/final_post.md"
    prompt: |
      The auditors flagged issues with the final post.
      Review the post above and either:
      - Type 'approve' to publish as-is
      - Type 'abort' to cancel
      - Provide feedback to guide the revision
    transitions:
      approved: complete
      feedback: synthesize
      abort: halt

  human-approval:
    type: human-approval
    description: "Human reviews final post and approves or requests changes"
    input: "workflow/final/final_post.md"
    prompt: |
      Review the final post above and either:
      - Type 'approve' to finalize
      - Type 'retry' to generate new drafts
      - Provide feedback for specific changes
    transitions:
      approved: complete
      retry: draft
      feedback: synthesize

  complete:
    type: terminal
    description: "Workflow complete - post ready for publishing"

  halt:
    type: terminal
    description: "Workflow halted due to failure or user abort"

# ============================================================================
# RUNTIME SETTINGS
# ============================================================================

runtime:
  working_dir: "workflow"
  parallel_fanout: true
  timeout_per_agent: 300
  retry_count: 2
